name: Deploy React App to S3 & CloudFront

on:
  push:
    branches: [ "main" ]  # main에 코드 합쳐지면 배포 실행
  pull_request:
    branches: [ "main" ]  # PR 올라오면 빌드 테스트만 실행

env:
  AWS_REGION: ap-northeast-2
  S3_BUCKET_NAME: s3-with-cloudfront-bucket-본인이름  # 수정 필요
  CLOUDFRONT_ID: E1XXXXXXXXXXXX  # CloudFront 배포ID로 수정 필요

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      # 소스 코드 가져오기
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # Node.js 세팅
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # 의존성 설치
      - name: Install Dependencies
        run: npm ci

      # Vite App 빌드 (PR은 여기까지 실행)
      - name: Vite App Build
        run: npm run build

      # AWS 인증
      - name: Configure AWS Credentials
        if: github.event_name == 'push'
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # S3 업로드 & CloudFront 캐시 삭제
      - name: Deploy to S3 & Invalidate CloudFront
        if: github.event_name == 'push'
        run: |
          # S3에 배포 (OAC 방식)
          aws s3 sync ./dist s3://${{ env.S3_BUCKET_NAME }} --delete
          # CloudFront 캐시 무효화 (사용자에게 즉시 새 버전 노출)
          aws cloudfront create-invalidation --distribution-id ${{ env.CLOUDFRONT_ID }} --paths "/*"
          # 도메인 조회해서 변수에 담기
          # --query 옵션: 도메인 이름만 추출
          CF_DOMAIN=$(aws cloudfront get-distribution --id ${{ env.CLOUDFRONT_ID }} --query "Distribution.DomainName" --output text)
          echo "배포 완료! https://$CF_DOMAIN"